<script>
    tinymce.init({
    selector: "#desc",
    theme: "modern",
//language : 'pt_BR',
    plugins: [
                "advlist autolink autosave link image lists charmap print preview hr anchor pagebreak spellchecker",
                "searchreplace wordcount visualblocks visualchars code fullscreen insertdatetime media nonbreaking",
                "table contextmenu directionality emoticons template textcolor paste fullpage textcolor colorpicker textpattern"
    ],
    //toolbar: "undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image     | print preview media",
    toolbar1: "fullpage | bold italic underline strikethrough | alignleft aligncenter alignright alignjustify | styleselect formatselect fontselect fontsizeselect",
        toolbar2: "searchreplace | bullist numlist | outdent indent blockquote | undo redo | link unlink anchor image code | insertdatetime preview | forecolor backcolor",
        toolbar3: "table | hr removeformat | subscript superscript | charmap emoticons  | ltr rtl | visualchars visualblocks ",

    menubar: false,
    toolbar_items_size: 'small',
    style_formats: [
                {title: 'Bold text', inline: 'b'},
                {title: 'Red text', inline: 'span', styles: {color: '#ff0000'}},
                {title: 'Red header', block: 'h1', styles: {color: '#ff0000'}},
                {title: 'Example 1', inline: 'span', classes: 'example1'},
                {title: 'Example 2', inline: 'span', classes: 'example2'},
                {title: 'Table styles'},
                {title: 'Table row 1', selector: 'tr', classes: 'tablerow1'}
        ]
});
</script>
<script>
$( "ul li" ).removeClass( "active" );
$( "ul li" ).addClass(function( index, currentClass ) {
  var addedClass;
 
  if ( currentClass === "linkpre" ) {
    addedClass = "active";
  }
 
  return addedClass;
});

</script>

<script>
    var $messages = $('#addForn-alert');
    
    $.validate({
        form : '#addFornform'/*,
        errorMessagePosition : $messages*/
    });
</script>
<div class="container"  style="padding-top:60px;">
    <div id="addFornbox" style="margin-top:50px;" class="mainbox col-md-10 col-md-offset-1 col-sm-8 col-sm-offset-2">
        <div class="panel panel-default" >
            <div class="panel-heading">
                <div class="panel-title">Novo Prestador</div>
            </div>     

            <div style="padding-top:30px" class="panel-body" >
                <div style="display:none" id="addForn-alert" class="alert alert-danger col-sm-12"></div>
                
                <form id="addFornform" class="form-horizontal" role="form" action="">
                    
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="nome">Nome</label>  
                      <div class="col-md-9">
                      <input id="nome" name="nome" type="text" placeholder="Nome" class="form-control input-md" data-validation="required" data-validation-error-msg="Campo obrigatório">

                      </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="const">Responsável</label>  
                      <div class="col-md-9">
                      <input id="responsavel" name="responsavel" type="text" placeholder="Responsável" class="form-control input-md" data-validation="required" data-validation-error-msg="Campo obrigatório">

                      </div>
                    </div>

                    <!-- Text input-->
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="endereco">Endereço</label>  
                      <div class="col-md-9">
                      <input id="endereco" name="endereco" type="text" placeholder="Endereço" class="form-control input-md" data-validation="required" data-validation-error-msg="Campo obrigatório">
                      <span class="help-block">Quanto mais completo o endereço, mais fácil será encontrar prestadores de serviço próximos ao imóvel.</span>  
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="tipo">Tipo de Serviço</label>
                      <div class="col-md-6">
                        <select id="tipo" name="tipo" class="form-control">
                          <option value="Pintura">Pintura</option>
                          <option value="Gesso">Gesso</option>
                          <option value="Marcenaria">Marcenaria</option>
                          <option value="Elétrica">Elétrica</option>
                          <option value="Ar-condicionado">Ar-condicionado</option>
                          <option value="Serralheria">Serralheria</option>
                          <option value="Viraçaria">Viraçaria</option>
                          <option value="Outros">Outros</option>
                        </select>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="fone">Descrição</label>  
                      <div class="col-md-9">
                          <textarea class="form-control input-md" rows="5" id="desc" name="desc" placeholder="Descreva em algumas palavras os serviços e diferenciais deste prestador"></textarea>
                      </div>
                    </div>
                    
                    <!-- Text input-->
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="fone">Telefone</label>  
                      <div class="col-md-9">
                        <input id="fone" name="fone" type="text" placeholder="Telefone" ui-mask="(99) 9999-9999" class="form-control input-md">
                      </div>
                    </div>
                    
                    <!-- Text input-->
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="email">E-mail</label>  
                      <div class="col-md-9">
                        <input id="email" name="email" type="text" placeholder="E-mail" class="form-control input-md">
                      </div>
                    </div>
                    
                    <!-- Text input-->
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="site">Site</label>  
                      <div class="col-md-9">
                        <input id="site" name="site" type="text" placeholder="Site" class="form-control input-md" data-validation="url" data-validation-error-msg="Digite uma url válida.">
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="face">Facebook</label>  
                      <div class="col-md-9">
                        <input id="face" name="face" type="text" placeholder="Facebook" class="form-control input-md">
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="whats">Whatsapp</label>  
                      <div class="col-md-9">
                        <input id="whats" name="whats" type="text" placeholder="Whatsapp" ui-mask="(99) 9999-9999" class="form-control input-md">
                      </div>
                    </div>

                    <!-- File Button --> 
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="logo">Logo</label>
<!--                         <form action="{{route('files.store')}}" method="post" enctype="multipart/form-data" id="logoupload" class="dropzone" role="form">-->
                        <div class="col-md-8 dropzone dz-clickable text-center" id="logoupload">
                        </div>
                    </div>
                    <!-- File Button --> 
                    <div class="form-group">
                      <label class="col-md-2 control-label" for="capa">Imagem de capa</label>
                      <div class="col-md-8 dropzone dz-clickable text-center" id="capaupload">
                      
                      </div>
                    </div>


                                <div style="margin-top:10px; float:right;" class="form-group">
                                    <!-- Button -->

                                    <div class="col-sm-12 controls">
                                        <a href="#/prestadores/" ui-sref="prestadores" class="btn-lg btn-danger">Cancelar</a>
                                        <input id="btn-add" type="submit" class="btn-lg btn-success" value="Salvar ">

                                    </div>
                                </div>  
                            </form>     



                        </div>                     
                    </div>  
        </div> 
    </div>


<script>    
//$("div#logoupload").dropzone({ url: "/imgupload.php", autoQueue: false });
//$("div#capaupload").dropzone({ url: "/imgupload.php", autoQueue: false });

var imgId;
    
var logoDropzone = new Dropzone("div#logoupload", { // Make the whole body a dropzone
  url: "/imgupload.php", // Set the url
  parallelUploads: 2,
  autoQueue: false
});

var capaDropzone = new Dropzone("div#capaupload", { // Make the whole body a dropzone
  url: "/imgupload.php", // Set the url
  parallelUploads: 2,
  autoQueue: false
});
    

$( "#addFornform" ).submit(function( event ) {
  //alert( "Handler for .submit() called." );
    
    if ($('.form-error').css( "display") != 'block'){
        addForn();
    }
    
    event.preventDefault();
});
    
function exibeAlert(msg){
    $('#addForn-alert').html(msg);
    $('#addForn-alert').css( "display", "block" );
}

function escondeAlert(){
    $('#addForn-alert').html('');
    $('#addForn-alert').css( "display", "none" );
}
    
function addForn() {
    
    var nome = $( "#nome" ).val();  
    var resp = $( "#responsavel" ).val(); 
    var endereco = $( "#endereco" ).val(); 
    var site = $( "#site" ).val(); 
    var email = $( "#email" ).val(); 
    var tel = $( "#fone" ).val(); 
    var tipo = $( "#tipo" ).val(); 
    var desc = $( "#desc" ).val();
    var face = $( "#face" ).val(); 
    var whats = $( "#whats" ).val();
    
    var Forn = Parse.Object.extend("fornecedor");
    var forn = new Forn();
    
    imgId = uniqID();
    
    forn.set("nome", nome);
    forn.set("responsavel", resp);
    forn.set("endereco", endereco);
    forn.set("tel", tel);
    forn.set("email", email);
    forn.set("site", site);
    forn.set("facebook", face);
    forn.set("whatsapp", whats);
    forn.set("servicos", tipo);
    forn.set("coment", desc);
    forn.set("capa", "/img/prest/" + imgId + "/capa-"+ capaDropzone.files[0].name);
    forn.set("logo", "/img/prest/" + imgId + "/logo-"+ logoDropzone.files[0].name);
    //forn.set("cadastropor", Parse.User.current().id );
    forn.set("cadastropor", { "__type": "Pointer", "className": "_User", "objectId": Parse.User.current().id });
    forn.set("verificado", false);
    forn.set("ativo", true);

    //console.log(logoDropzone);
    logoDropzone.enqueueFiles(logoDropzone.getFilesWithStatus(Dropzone.ADDED));
    capaDropzone.enqueueFiles(capaDropzone.getFilesWithStatus(Dropzone.ADDED));

    forn.save(null, {
        success: function(emp) {
            
            
            //empId = emp.id;
            //localStorage.setItem('empId', emp.id);
            logoDropzone.processQueue();
            capaDropzone.processQueue();
            
            $(location).attr('href','#/prest/'+forn.id);
        },
        error: function(grupo, error) {
            exibeAlert('Ocorreu um erro: ' + error.message);
        }
    });
}
    
/*$('#btn-add').click(function(){           
     logoDropzone.processQueue();
});*/
    
logoDropzone.on("sending", function(file, xhr, formData) {
    formData.append('empId', imgId);
    formData.append('tipo', 'logo-');
    formData.append('folder', 'prest');

});
    
capaDropzone.on("sending", function(file, xhr, formData) {
    formData.append('empId', imgId);
    formData.append('tipo', 'capa-');
    formData.append('folder', 'prest');
});
    
function uniqID(idlength) {
    
    var charstoformid = '_0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz'.split('');
    if (! idlength) {
        idlength = Math.floor(Math.random() * charstoformid.length);
    }
    var uniqid = '';
    for (var i = 0; i < length; i++) {
        uniqid += charstoformid[Math.floor(Math.random() * charstoformid.length)];
    }
            
    return uniqid;
}

</script>
